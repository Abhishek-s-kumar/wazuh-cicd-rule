name: Update Rulesets on SIEM
on:
  push:
    branches: [ "main" ]
    paths: ["rules/**", "decoders/**"]
  workflow_dispatch:

jobs:
  DaaC:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create backup
        run: |
          sudo mkdir -p /backup/
          sudo cp -r /var/ossec/etc/rules /backup/wazuh-rules 2>/dev/null || true
          sudo cp -r /var/ossec/etc/decoders /backup/wazuh-decoders 2>/dev/null || true

      - name: Performance baseline
        run: python tests/performance_monitor.py --action baseline

      - name: Copy new rules and decoders
        run: |
          sudo mkdir -p /var/ossec/etc/rules /var/ossec/etc/decoders
          [ -d "rules" ] && sudo cp rules/*.xml /var/ossec/etc/rules/ 2>/dev/null || true
          [ -d "decoders" ] && sudo cp decoders/*.xml /var/ossec/etc/decoders/ 2>/dev/null || true

      - name: Set permissions
        run: |
          sudo chown wazuh:wazuh /var/ossec/etc/rules/* 2>/dev/null || true
          sudo chmod 660 /var/ossec/etc/rules/* 2>/dev/null || true
          sudo chown wazuh:wazuh /var/ossec/etc/decoders/* 2>/dev/null || true
          sudo chmod 660 /var/ossec/etc/decoders/* 2>/dev/null || true

      - name: Restart Wazuh manager
        run: |
          sudo systemctl restart wazuh-manager
          echo "Wazuh manager restarted successfully"

      - name: Performance comparison
         run: |
          python3 scripts/kali_performance_monitor.py
        continue-on-error: true

      - name: Show Wazuh status
        run: |
          sudo systemctl status wazuh-manager --no-pager

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          sudo cp -r /backup/wazuh-rules/* /var/ossec/etc/rules/ 2>/dev/null || true
          sudo cp -r /backup/wazuh-decoders/* /var/ossec/etc/decoders/ 2>/dev/null || true
          sudo systemctl restart wazuh-manager
          exit 1